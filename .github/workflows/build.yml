name: Build Arduino Examples

on:
  push:
  release:
    types: [created]

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      examples: ${{ steps.discover.outputs.examples }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - id: discover
        run: |
          EXAMPLES=$(find examples -mindepth 1 -maxdepth 1 -type d ! -name 'testdata' -exec basename {} \; | jq -R . | jq -s .)
          echo "::set-output name=examples::$EXAMPLES"
  build:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      matrix:
        example: ${{ fromJson(needs.discover.outputs.examples) }}
        fqbn: [arduino:avr:uno, arduino:mbed_rp2040:pico]
        cli_syntax: [short, long]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1
      - name: Install platforms
        run: |
          arduino-cli core install arduino:avr
          arduino-cli core install arduino:mbed_rp2040
      - name: Compile sketch
        run: |
          BUILD_PROPERTIES=""
          if [ "${{ matrix.cli_syntax }}" == "long" ]; then
            BUILD_PROPERTIES="--build-property build.extra_flags=-DUSE_EXTENDED_CLI_SYNTAX=1"
          else
            BUILD_PROPERTIES="--build-property build.extra_flags=-DUSE_EXTENDED_CLI_SYNTAX=0"
          fi
          arduino-cli compile --fqbn ${{ matrix.fqbn }} --library . $BUILD_PROPERTIES examples/${{ matrix.example }} --output-dir gen/build/${{ matrix.example }}-${{ matrix.fqbn }}-${{ matrix.cli_syntax }}
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.example }}-${{ matrix.fqbn }}-${{ matrix.cli_syntax }}
          path: gen/build/${{ matrix.example }}-${{ matrix.fqbn }}-${{ matrix.cli_syntax }}

  validate-xml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install libxml2-utils
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils
      - name: Validate XML files
        run: xmllint --noout --schema clients/xml/xTrainEvents.xsd clients/xml/*.xml

  validate-swagger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: pip install openapi-spec-validator
      - name: Validate OpenAPI spec
        run: openapi-spec-validator clients/swagger/openapi.yaml

  release:
    needs: [build, validate-xml, validate-swagger]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: gen/artifacts

      - name: Prepare release assets
        run: |
          mkdir gen/release-assets
          git archive --format=zip --output=gen/release-assets/xDuinoRails_xTrainAPI.zip --prefix=xDuinoRails_xTrainAPI/ HEAD
          for artifact_dir in gen/artifacts/*; do
            if [ -d "$artifact_dir" ]; then
              artifact_name=$(basename "$artifact_dir")
              find "$artifact_dir" -type f \( -name "*.hex" -o -name "*.elf" -o -name "*.uf2" \) | while read -r file_path; do
                extension="${file_path##*.}"
                sanitized_artifact_name=$(echo "$artifact_name" | tr ':' '_')
                new_filename="gen/release-assets/${sanitized_artifact_name}.${extension}"
                mv "$file_path" "$new_filename"
              done
            fi
          done
      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: gen/release-assets/*

  build-and-deploy-docs:
    # NOTE: This job correctly generates the MkDocs, Doxygen and Redocly/Swagger
    # documentation and deploys it to the 'gh-pages' branch. If the documentation
    # links in the README are broken, the repository's GitHub Pages settings
    # must be configured to serve from the 'gh-pages' branch.
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Doxygen
        run: sudo apt-get update && sudo apt-get install -y doxygen

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install MkDocs
        run: pip install mkdocs

      - name: Install Redocly CLI
        run: npm install -g @redocly/cli

      - name: Prepare MkDocs source
        run: |
          mkdir -p gen/site_source/docs
          cp *.en.md gen/site_source/
          cp docs/*.en.md gen/site_source/docs/
          mv gen/site_source/README.en.md gen/site_source/index.md

      - name: Build MkDocs site
        run: mkdocs build --config-file docs/mkdocs.yml

      - name: Generate Doxygen documentation
        run: doxygen spec/Doxyfile

      - name: Generate Redocly documentation
        run: |
          mkdir -p gen/public/swagger
          redocly build-docs clients/swagger/openapi.yaml -o gen/public/swagger/index.html

      - name: Copy swagger spec for webtool
        run: cp clients/swagger/openapi.yaml gen/public/swagger/

      - name: Copy webtool to public directory
        run: cp -r webtool gen/public/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gen/public
