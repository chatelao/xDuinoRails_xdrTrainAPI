name: Build Arduino Examples

on:
  push:
  release:
    types: [created]

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      examples: ${{ steps.discover.outputs.examples }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - id: discover
        run: |
          EXAMPLES=$(find examples -mindepth 1 -maxdepth 1 -type d ! -name 'testdata' -exec basename {} \; | jq -R . | jq -s .)
          echo "::set-output name=examples::$EXAMPLES"
  build:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      matrix:
        example: ${{ fromJson(needs.discover.outputs.examples) }}
        fqbn: [arduino:avr:uno, arduino:mbed_rp2040:pico]
        cli_syntax: [short, long]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1
      - name: Install platforms
        run: |
          arduino-cli core install arduino:avr
          arduino-cli core install arduino:mbed_rp2040
      - name: Compile sketch
        run: |
          BUILD_PROPERTIES=""
          if [ "${{ matrix.cli_syntax }}" == "long" ]; then
            BUILD_PROPERTIES="--build-property build.extra_flags=-DUSE_EXTENDED_CLI_SYNTAX=1"
          else
            BUILD_PROPERTIES="--build-property build.extra_flags=-DUSE_EXTENDED_CLI_SYNTAX=0"
          fi
          arduino-cli compile --fqbn ${{ matrix.fqbn }} --library lib $BUILD_PROPERTIES examples/${{ matrix.example }} --output-dir build/${{ matrix.example }}-${{ matrix.fqbn }}-${{ matrix.cli_syntax }}
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.example }}-${{ matrix.fqbn }}-${{ matrix.cli_syntax }}
          path: build/${{ matrix.example }}-${{ matrix.fqbn }}-${{ matrix.cli_syntax }}

  validate-xml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install libxml2-utils
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils
      - name: Validate XML files
        run: xmllint --noout --schema xml/xTrainEvents.xsd xml/*.xml

  validate-swagger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: pip install openapi-spec-validator
      - name: Validate OpenAPI spec
        run: openapi-spec-validator swagger/openapi.yaml

  release:
    needs: [build, validate-xml, validate-swagger]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      - name: Prepare release assets
        run: |
          mkdir release-assets
          for artifact_dir in artifacts/*; do
            if [ -d "$artifact_dir" ]; then
              artifact_name=$(basename "$artifact_dir")
              find "$artifact_dir" -type f \( -name "*.hex" -o -name "*.elf" -o -name "*.uf2" \) | while read -r file_path; do
                extension="${file_path##*.}"
                sanitized_artifact_name=$(echo "$artifact_name" | tr ':' '_')
                new_filename="release-assets/${sanitized_artifact_name}.${extension}"
                mv "$file_path" "$new_filename"
              done
            fi
          done
      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*

  build-and-deploy-docs:
    # NOTE: This job correctly generates the Doxygen and Redocly/Swagger
    # documentation and deploys it to the 'gh-pages' branch. If the documentation
    # links in the README are broken, the repository's GitHub Pages settings
    # must be configured to serve from the 'gh-pages' branch.
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Doxygen
        run: sudo apt-get update && sudo apt-get install -y doxygen

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Redocly CLI
        run: npm install -g @redocly/cli

      - name: Create Doxygen output directory
        run: mkdir -p public/doxygen

      - name: Generate Doxygen documentation
        run: doxygen Doxyfile

      - name: Generate Redocly documentation
        run: |
          mkdir -p public/swagger
          redocly build-docs swagger/openapi.yaml -o public/swagger/index.html

      - name: Copy swagger spec for webtool
        run: cp swagger/openapi.yaml public/swagger/

      - name: Copy webtool to public directory
        run: cp -r webtool public/

      - name: Create index page
        run: |
          echo '<!DOCTYPE html>
          <html>
          <head>
            <title>xTrain API Documentation</title>
          </head>
          <body>
            <h1>xTrain API Documentation</h1>
            <ul>
              <li><a href="doxygen/index.html">Doxygen (C++ API)</a></li>
              <li><a href="swagger/index.html">Redocly (REST API)</a></li>
              <li><a href="webtool/index.html">Web Tool</a></li>
            </ul>
          </body>
          </html>' > public/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
